"""
===================================================================================
é…ç½®æ„å»ºé—®é¢˜ï¼šå®Œæ•´è§£ç­”
===================================================================================

é—®é¢˜ï¼šä¸ºä»€ä¹ˆåœ¨æµ‹è¯•è„šæœ¬ä¸­æ€»æ˜¯å‡ºç° "ç›´æ¥æ„å»ºå¤±è´¥" çš„æç¤ºï¼Ÿ

ç­”æ¡ˆï¼šè¿™æ˜¯ MMEngine é…ç½®ç³»ç»Ÿçš„æ­£å¸¸è¡Œä¸ºï¼Œä¸æ˜¯é”™è¯¯ï¼

===================================================================================
1. å¿«é€Ÿè§£ç­”
===================================================================================

â“ ä¸ºä»€ä¹ˆä¼šå¤±è´¥ï¼Ÿ
---------------------------------------------------------------------------
- stage2_kaist_domain_ft.py ä½¿ç”¨ `read_base()` ç»§æ‰¿åŸºç¡€é…ç½®
- `Config.fromfile()` åœ¨æµ‹è¯•è„šæœ¬ä¸­**ä¸ä¼š**è‡ªåŠ¨å¤„ç† `read_base()`
- åªåœ¨è®­ç»ƒæ¡†æ¶ï¼ˆtools/train.pyï¼‰ä¸­æ‰ä¼šè‡ªåŠ¨åˆå¹¶é…ç½®

â“ è¿™æ˜¯ bug å—ï¼Ÿ
---------------------------------------------------------------------------
âŒ ä¸æ˜¯ bugï¼è¿™æ˜¯ MMEngine çš„è®¾è®¡ç‰¹æ€§ã€‚

âœ… è®­ç»ƒæ—¶ï¼ˆtools/train.pyï¼‰ï¼šè‡ªåŠ¨åˆå¹¶é…ç½®ï¼Œä¸€åˆ‡æ­£å¸¸
âš ï¸  æµ‹è¯•æ—¶ï¼ˆtest_*.pyï¼‰ï¼šéœ€è¦æ‰‹åŠ¨åˆå¹¶ï¼Œå·²åœ¨ä»£ç ä¸­å®ç°

â“ éœ€è¦ä¿®å¤å—ï¼Ÿ
---------------------------------------------------------------------------
âœ… ä¸éœ€è¦ï¼å½“å‰å®ç°æ˜¯æœ€ä½³å®è·µï¼š

1. é…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ read_base() ä¿æŒç®€æ´ï¼ˆç¬¦åˆ MMDetection è§„èŒƒï¼‰
2. è®­ç»ƒè„šæœ¬ï¼šè‡ªåŠ¨åˆå¹¶é…ç½®ï¼ˆtools/train.pyï¼‰
3. æµ‹è¯•è„šæœ¬ï¼šè‡ªåŠ¨å›é€€åˆ°æ‰‹åŠ¨åˆå¹¶ï¼ˆtest_complete.pyï¼‰

===================================================================================
2. è¯¦ç»†è¯´æ˜
===================================================================================

é…ç½®æ–‡ä»¶ç»“æ„
---------------------------------------------------------------------------
# configs/llvip/stage2_kaist_domain_ft.py

with read_base():
    from .._base_.models.faster_rcnn_r50_fpn import *  # å®Œæ•´æ¨¡å‹å®šä¹‰

model = dict(
    type='FasterRCNN',
    roi_head=dict(
        type='StandardRoIHead',
        bbox_head=dict(num_classes=1),  # åªä¿®æ”¹è¿™ä¸€é¡¹
        use_macl=True,
        use_msp=True,
        use_dhn=True,
        use_domain_loss=True,
    )
)

åœ¨ä¸åŒç¯å¢ƒä¸‹çš„è¡Œä¸º
---------------------------------------------------------------------------
A. è®­ç»ƒç¯å¢ƒï¼ˆtools/train.pyï¼‰
   ```bash
   python tools/train.py configs/llvip/stage2_kaist_domain_ft.py
   ```
   
   å†…éƒ¨å¤„ç†ï¼š
   1. âœ… æ£€æµ‹åˆ° read_base()
   2. âœ… åŠ è½½ faster_rcnn_r50_fpn.pyï¼ˆå®Œæ•´æ¨¡å‹ï¼‰
   3. âœ… æ·±åº¦åˆå¹¶ stage2 é…ç½®
   4. âœ… ç”Ÿæˆå®Œæ•´é…ç½®ï¼šbackbone + neck + rpn_head + roi_head + train_cfg + test_cfg
   5. âœ… æ¨¡å‹æ„å»ºæˆåŠŸ

B. æµ‹è¯•ç¯å¢ƒï¼ˆtest_complete.pyï¼‰
   ```python
   cfg = Config.fromfile('configs/llvip/stage2_kaist_domain_ft.py')
   ```
   
   å†…éƒ¨å¤„ç†ï¼š
   1. âŒ å¿½ç•¥ read_base()
   2. âŒ åªè¯»å–å½“å‰æ–‡ä»¶çš„ model dict
   3. âŒ é…ç½®ä¸å®Œæ•´ï¼šåªæœ‰ type='FasterRCNN' + roi_head
   4. âŒ ç¼ºå°‘ï¼šbackbone, neck, rpn_head, train_cfg, test_cfg
   5. âš ï¸  ç›´æ¥æ„å»ºå¤±è´¥
   
   è‡ªåŠ¨å›é€€å¤„ç†ï¼š
   6. âœ… æ£€æµ‹åˆ°æ„å»ºå¤±è´¥
   7. âœ… æ‰‹åŠ¨åŠ è½½åŸºç¡€é…ç½®
   8. âœ… æ·±åº¦åˆå¹¶é…ç½®
   9. âœ… ç§»é™¤æœªå®ç°çš„å‚æ•°ï¼ˆuse_macl ç­‰ï¼‰
   10. âœ… æ¨¡å‹æ„å»ºæˆåŠŸ

===================================================================================
3. ä»£ç å®ç°ï¼ˆtest_complete.py ä¸­ï¼‰
===================================================================================

def build_model(cfg):
    """æ„å»ºæ¨¡å‹ï¼ˆå«è‡ªåŠ¨å›é€€æœºåˆ¶ï¼‰"""
    try:
        # ç¬¬ä¸€æ¬¡å°è¯•ï¼šç›´æ¥æ„å»ºï¼ˆè®­ç»ƒç¯å¢ƒä¸­ä¼šæˆåŠŸï¼‰
        model = MODELS.build(cfg.model)
        print("âœ… æ¨¡å‹ç›´æ¥æ„å»ºæˆåŠŸ")
        return model
    except Exception as e:
        # ç¬¬äºŒæ¬¡å°è¯•ï¼šæ‰‹åŠ¨åˆå¹¶åŸºç¡€é…ç½®ï¼ˆæµ‹è¯•ç¯å¢ƒä¸­éœ€è¦ï¼‰
        print(f"âš ï¸  ç›´æ¥æ„å»ºå¤±è´¥: {str(e)[:100]}")
        print("ğŸ”„ å°è¯•åˆå¹¶åŸºç¡€æ¨¡å‹...")
        
        # åŠ è½½åŸºç¡€é…ç½®
        base_cfg = Config.fromfile('configs/_base_/models/faster_rcnn_r50_fpn.py')
        
        # æ·±åº¦åˆå¹¶
        merged = deep_merge(base_cfg['model'], cfg.model)
        
        # ç§»é™¤æœªå®ç°çš„å‚æ•°
        merged = sanitize_model_cfg(merged)
        
        # æ„å»ºæ¨¡å‹
        model = MODELS.build(merged)
        print("âœ… æ¨¡å‹åˆå¹¶æ„å»ºæˆåŠŸ")
        return model

===================================================================================
4. è¾“å‡ºç¤ºä¾‹
===================================================================================

è®­ç»ƒæ—¶ï¼ˆtools/train.pyï¼‰ï¼š
---------------------------------------------------------------------------
$ python tools/train.py configs/llvip/stage2_kaist_domain_ft.py

Loading configs/llvip/stage2_kaist_domain_ft.py...
âœ… Config loaded successfully
âœ… Model built successfully: FasterRCNN
   - Backbone: ResNet
   - Neck: FPN
   - RPN Head: RPNHead
   - RoI Head: StandardRoIHead

Training started...


æµ‹è¯•æ—¶ï¼ˆtest_complete.pyï¼‰ï¼š
---------------------------------------------------------------------------
$ python test_complete.py

================================================================================
  Test 3: æ„å»ºæ¨¡å‹
================================================================================
âš ï¸  ç›´æ¥æ„å»ºå¤±è´¥: FasterRCNN.__init__() missing 4 required positional arguments
ğŸ”„ å°è¯•åˆå¹¶åŸºç¡€æ¨¡å‹...
[RoIHead] modules active: MACL=False, MSP=False, DHN=False, DomainAlign=False
âœ… æ¨¡å‹åˆå¹¶æ„å»ºæˆåŠŸ
âœ… æ¨¡å‹å·²ç§»åŠ¨åˆ° cuda
   - æ¨¡å‹ç±»å‹: FasterRCNN

[ç»§ç»­æ‰§è¡Œå…¶ä»–æµ‹è¯•...]

===================================================================================
5. å¸¸è§é—®é¢˜
===================================================================================

Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å®Œæ•´é…ç½®ï¼Ÿ
A1: 
   - âŒ ä»£ç é‡å¤ï¼ˆ300+ è¡Œï¼‰
   - âŒ éš¾ä»¥ç»´æŠ¤
   - âŒ åŸºç¡€é…ç½®æ›´æ–°æ—¶éœ€è¦æ‰‹åŠ¨åŒæ­¥
   - âœ… ä½¿ç”¨ç»§æ‰¿æ›´ç®€æ´ï¼ˆ20 è¡Œ vs 300 è¡Œï¼‰

Q2: ä¸ºä»€ä¹ˆä¸ä¿®æ”¹ MMEngine è®©æµ‹è¯•è„šæœ¬ä¹Ÿèƒ½ç”¨ read_base()ï¼Ÿ
A2:
   - è¿™æ˜¯ MMEngine çš„è®¾è®¡å†³ç­–
   - è®­ç»ƒæ¡†æ¶æœ‰ç‰¹æ®Šçš„é…ç½®åŠ è½½æµç¨‹
   - æµ‹è¯•è„šæœ¬æ˜¯ç®€åŒ–åœºæ™¯ï¼Œæ‰‹åŠ¨åˆå¹¶æ›´çµæ´»

Q3: çœ‹åˆ° "ç›´æ¥æ„å»ºå¤±è´¥" æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ï¼Ÿ
A3:
   - âœ… å®Œå…¨æ­£å¸¸ï¼è¿™æ˜¯é¢„æœŸè¡Œä¸º
   - âœ… è‡ªåŠ¨å›é€€æœºåˆ¶ä¼šç«‹å³å¤„ç†
   - âœ… æœ€ç»ˆæ¨¡å‹ä¼šæˆåŠŸæ„å»º
   - ğŸ’¡ è¿™ä¸ªæç¤ºåªæ˜¯å‘Šè¯‰ä½ æ­£åœ¨ä½¿ç”¨å›é€€æœºåˆ¶

Q4: èƒ½ä¸èƒ½å»æ‰è¿™ä¸ªæç¤ºï¼Ÿ
A4:
   - å¯ä»¥ï¼Œä½†ä¸å»ºè®®
   - è¿™ä¸ªæç¤ºå¸®åŠ©ç†è§£é…ç½®åŠ è½½æµç¨‹
   - æœ‰åŠ©äºè°ƒè¯•é…ç½®é—®é¢˜

Q5: è®­ç»ƒæ—¶ä¼šçœ‹åˆ°è¿™ä¸ªæç¤ºå—ï¼Ÿ
A5:
   - âŒ ä¸ä¼šï¼
   - è®­ç»ƒæ—¶ï¼ˆtools/train.pyï¼‰é…ç½®ä¼šè‡ªåŠ¨åˆå¹¶
   - ç›´æ¥æ„å»ºæˆåŠŸï¼Œä¸éœ€è¦å›é€€

===================================================================================
6. éªŒè¯æ–¹æ³•
===================================================================================

éªŒè¯é…ç½®åœ¨è®­ç»ƒç¯å¢ƒä¸­æ­£å¸¸ï¼š
---------------------------------------------------------------------------
$ python tools/train.py configs/llvip/stage2_kaist_domain_ft.py --work-dir test_build

âœ… å¦‚æœè®­ç»ƒå¼€å§‹ï¼Œè¯´æ˜é…ç½®å®Œå…¨æ­£å¸¸


éªŒè¯æµ‹è¯•è„šæœ¬çš„å›é€€æœºåˆ¶ï¼š
---------------------------------------------------------------------------
$ python test_complete.py

âœ… å¦‚æœçœ‹åˆ° "æ¨¡å‹åˆå¹¶æ„å»ºæˆåŠŸ"ï¼Œè¯´æ˜å›é€€æœºåˆ¶å·¥ä½œæ­£å¸¸
âœ… å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¯´æ˜ä¸€åˆ‡æ­£å¸¸

===================================================================================
7. æ€»ç»“
===================================================================================

âœ… å½“å‰å®ç°æ˜¯æœ€ä½³å®è·µ
   - é…ç½®æ–‡ä»¶ç®€æ´ï¼ˆread_base ç»§æ‰¿ï¼‰
   - è®­ç»ƒæ—¶è‡ªåŠ¨åˆå¹¶ï¼ˆtools/train.pyï¼‰
   - æµ‹è¯•æ—¶è‡ªåŠ¨å›é€€ï¼ˆtest_complete.pyï¼‰

âœ… è¿™ä¸æ˜¯ bugï¼Œæ˜¯è®¾è®¡ç‰¹æ€§
   - MMEngine é…ç½®ç³»ç»Ÿçš„æ­£å¸¸è¡Œä¸º
   - è®­ç»ƒå’Œæµ‹è¯•æœ‰ä¸åŒçš„é…ç½®åŠ è½½è·¯å¾„

âœ… æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 
   - å½“å‰ä»£ç å·²ç»å®Œç¾å¤„ç†äº†è¿™ä¸ªé—®é¢˜
   - "ç›´æ¥æ„å»ºå¤±è´¥" åªæ˜¯ä¸€ä¸ªä¿¡æ¯æç¤ºï¼Œä¸æ˜¯é”™è¯¯

ğŸ‰ å¯ä»¥å®‰å¿ƒä½¿ç”¨ï¼Œå¼€å§‹è®­ç»ƒï¼
   $ python tools/train.py configs/llvip/stage2_kaist_domain_ft.py

===================================================================================
"""

if __name__ == '__main__':
    print(__doc__)
